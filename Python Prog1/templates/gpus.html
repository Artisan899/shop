<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Видеокарты</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-img-top {
            height: 200px;
            object-fit: contain;
        }
        .card-body {
            display: flex;
            flex-direction: column;
        }
        .price {
            font-size: 1.25rem;
            font-weight: bold;
            color: #d9534f;
        }
        .btn-add-to-cart {
            background-color: #28a745;
            color: white;
            font-weight: bold;
        }
        .btn-add-to-cart:hover {
            background-color: #218838;
        }
        .cart-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }
        .cart-status {
            font-weight: bold;
            color: #28a745;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .quantity-controls button {
            width: 30px;
            height: 30px;
            font-weight: bold;
            font-size: 18px;
            padding: 0;
        }
        .btn-outline-danger {
            border-color: #dc3545;
            color: #dc3545;
        }

        .btn-outline-danger:hover {
            background-color: #dc3545;
            color: white;
        }

        /* Иконка внутри кнопки */
        .bi-trash {
            margin-right: 5px;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-3">
    <!-- Кнопка Корзина справа сверху -->
    <div class="d-flex justify-content-end gap-3">  <!-- Добавили gap-3 для отступа между кнопками -->
    <!-- Кнопка "Очистить корзину" -->
    <button class="btn btn-outline-danger d-inline-flex align-items-center"
            onclick="clearCart()"
            id="clear-cart-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash me-1" viewBox="0 0 16 16">
            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
        </svg>
        Очистить
    </button>

    <!-- Существующая кнопка корзины -->
    <a href="/cart" class="btn btn-outline-primary d-inline-flex flex-column align-items-center" id="cart-button">
        <img id="cart-icon" src="{{ url_for('static', filename='pin/basket.jpg') }}" alt="Корзина" style="width: 40px; height: 40px;">
        <span>Корзина</span>
    </a>
</div>

<div class="container mt-4">
    <h2 class="text-center mb-4">Видеокарты</h2>
    <div class="row row-cols-1 row-cols-md-3 g-4">
        {% for gpu in gpus %}
        <div class="col">
            <div class="card h-100">
                <img src="{{ url_for('static', filename='images/gpus/' + gpu.image) }}" class="card-img-top" alt="{{ gpu.name }}">
                <div class="card-body">
                    <h5 class="card-title">{{ gpu.name }}</h5>

                    <ul class="list-unstyled">
                        <li><strong>Память:</strong> {{ gpu.memory }}</li>
                        <li><strong>Тип памяти:</strong> {{ gpu.memory_type }}</li>
                        <li><strong>Частота:</strong> {{ gpu.clock_speed }} MHz </li>

                    </ul>
                    <p class="price">Цена: {{ gpu.price }} ₽</p>



                    <button class="btn btn-add-to-cart"
                            onclick="addToCart(this, '{{ gpu.id }}', 'gpu')">
                        В корзину
                    </button>

                    <!-- Панель управления корзиной (скрыта по умолчанию) -->
                    <div class="cart-controls d-none">
                        <span class="cart-status">Уже в вашей корзине</span>
                        <div class="quantity-controls">
                            <button class="btn btn-outline-secondary btn-sm" onclick="changeQuantity(this, -1)">−</button>
                            <span class="quantity">1</span>
                            <button class="btn btn-outline-secondary btn-sm" onclick="changeQuantity(this, 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    let cartCount = 0;

    function updateCartIcon() {
        const cartIcon = document.getElementById('cart-icon');
        let imageName = 'basket.jpg'; // default (empty)

        if (cartCount >= 1 && cartCount <= 5) {
            imageName = `basket${cartCount}.jpg`;
        } else if (cartCount > 5) {
            imageName = 'basket55.jpg';
        }

        cartIcon.src = `/static/pin/${imageName}`;
    }

    function addToCart(button) {
        const cardBody = button.closest('.card-body');
        const controls = cardBody.querySelector('.cart-controls');
        button.classList.add('d-none');
        controls.classList.remove('d-none');

        cartCount++;
        updateCartIcon();
    }

    function changeQuantity(btn, delta) {
        const controls = btn.closest('.cart-controls');
        const quantityDisplay = controls.querySelector('.quantity');
        let quantity = parseInt(quantityDisplay.textContent);

        if (quantity === 1 && delta === -1) {
            // Скрыть панель управления и вернуть кнопку "В корзину"
            controls.classList.add('d-none');
            const cardBody = btn.closest('.card-body');
            const addButton = cardBody.querySelector('.btn-add-to-cart');
            addButton.classList.remove('d-none');

            cartCount--;
            if (cartCount < 0) cartCount = 0;
            updateCartIcon();
            return;
        }

        quantity += delta;
        quantityDisplay.textContent = quantity;

        // Обновление глобального счётчика корзины
        cartCount += delta;
        if (cartCount < 0) cartCount = 0;
        updateCartIcon();
    }
</script>


<script>
// Общая функция для обновления иконки корзины
function updateCartIcon() {
    fetch('/get_cart_count')
        .then(response => response.json())
        .then(data => {
            const cartIcon = document.getElementById('cart-icon');
            let imageName = 'basket.jpg';
            const count = data.cart_count;

            if (count >= 1 && count <= 5) {
                imageName = `basket${count}.jpg`;
            } else if (count > 5) {
                imageName = 'basket55.jpg';
            }

            if (cartIcon) {
                cartIcon.src = `/static/pin/${imageName}`;
            }
        });
}

// Функция добавления в корзину
function addToCart(button, productId, productType) {
    fetch('/add_to_cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `product_id=${productId}&product_type=${productType}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const cardBody = button.closest('.card-body');
            const controls = cardBody.querySelector('.cart-controls');
            button.classList.add('d-none');
            controls.classList.remove('d-none');
            updateCartIcon();
        }
    });
}

// Функция изменения количества
function changeQuantity(btn, delta, productId, productType) {
    const controls = btn.closest('.cart-controls');
    const quantityDisplay = controls.querySelector('.quantity');
    let quantity = parseInt(quantityDisplay.textContent);
    quantity += delta;

    if (quantity <= 0) {
        quantity = 0;
        controls.classList.add('d-none');
        const cardBody = btn.closest('.card-body');
        const addButton = cardBody.querySelector('.btn-add-to-cart');
        addButton.classList.remove('d-none');
    }

    quantityDisplay.textContent = quantity;

    fetch('/update_cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `product_id=${productId}&product_type=${productType}&quantity=${quantity}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateCartIcon();
        }
    });
}

// Обновляем иконку при загрузке страницы
document.addEventListener('DOMContentLoaded', updateCartIcon)

    function clearCart() {
    if (confirm('Вы точно хотите очистить всю корзину?')) {
        fetch('/clear_cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Обновляем все кнопки "В корзину" на странице
                document.querySelectorAll('.btn-add-to-cart').forEach(btn => {
                    btn.classList.remove('d-none');
                });

                // Скрываем все панели управления количеством
                document.querySelectorAll('.cart-controls').forEach(control => {
                    control.classList.add('d-none');
                });

                // Обновляем иконку корзины
                updateCartIcon();

                // Показываем уведомление
                alert('Корзина очищена!');
            }
        });
    }
}


</script>

</body>
</html>